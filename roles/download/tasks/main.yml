---

- name: Download k3s binary x64
  get_url:
    url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
    checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-amd64.txt
    dest: /usr/local/bin/k3s
    owner: root
    group: root
    mode: 0755
  when: ansible_facts.architecture == "x86_64"

- name: Download k3s binary arm64
  block:
    - name: Create temp directory
      ansible.builtin.file:
        path: /tmp/k3s
        state: directory
        mode: '0755'
      
    - name: Download k3s binary arm64
      ansible.builtin.command:
        cmd: "curl -sSL https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s-arm64 -o /usr/local/bin/k3s"
      args:
        creates: /usr/local/bin/k3s
      
    - name: Download checksums for verification
      ansible.builtin.command:
        cmd: "curl -sSL https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-arm64.txt -o /tmp/k3s/sha256sum.txt"
    
    - name: Get expected checksum for k3s-arm64
      ansible.builtin.shell:
        cmd: "grep 'k3s-arm64' /tmp/k3s/sha256sum.txt | awk '{print $1}'"
      register: expected_checksum
    
    - name: Get actual checksum of downloaded file
      ansible.builtin.shell: 
        cmd: "sha256sum /usr/local/bin/k3s | awk '{print $1}'"
      register: actual_checksum
    
    - name: Compare checksums
      ansible.builtin.assert:
        that: "actual_checksum.stdout == expected_checksum.stdout"
        msg: "Checksum verification failed. Expected: {{ expected_checksum.stdout }}, Got: {{ actual_checksum.stdout }}"
      
    - name: Set permissions
      ansible.builtin.file:
        path: /usr/local/bin/k3s
        owner: root
        group: root
        mode: '0755'
  when:
    - ( ansible_facts.architecture is search("arm") and
        ansible_facts.userspace_bits == "64" ) or
      ansible_facts.architecture is search("aarch64")

- name: Download k3s binary armhf
  get_url:
    url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s-armhf
    checksum: sha256:https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/sha256sum-arm.txt
    dest: /usr/local/bin/k3s
    owner: root
    group: root
    mode: 0755
  when:
    - ansible_facts.architecture is search("arm")
    - ansible_facts.userspace_bits == "32"
